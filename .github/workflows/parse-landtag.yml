name: Parse Landtag PDF

on:
  workflow_dispatch:
    inputs:
      pdf_url:
        description: "PDF-URL (leer lassen, wenn URLs-Liste genutzt wird)"
        required: false
        type: string
      list_file:
        description: "Pfad zur URLs-Liste im Repo (eine URL pro Zeile)"
        required: false
        default: "scripts/urls.txt"
        type: string
      force_download:
        description: "PDF(s) immer neu laden"
        required: false
        default: true
        type: boolean

permissions:
  contents: write

concurrency:
  group: parse-landtag
  cancel-in-progress: false

jobs:
  parse:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install dependencies
        shell: bash
        run: |
          set -eo pipefail
          sudo apt-get update
          sudo apt-get install -y jq
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pdfplumber requests jsonschema
          fi
          python --version

      - name: Prepare output dir
        shell: bash
        run: |
          set -eo pipefail
          rm -rf data || true
          mkdir -p data
          if [ "${{ inputs.force_download }}" = "true" ]; then
            rm -rf .cache/pdfs || true
          fi

      - name: Detect parser script path
        id: detect
        shell: bash
        run: |
          set -eo pipefail
          if [ -f "scripts/parse_landtag_pdf.py" ]; then
            echo "script=scripts/parse_landtag_pdf.py" >> "$GITHUB_OUTPUT"
          elif [ -f "parse_landtag_pdf.py" ]; then
            echo "script=parse_landtag_pdf.py" >> "$GITHUB_OUTPUT"
          elif [ -f "parse_landtag_pdf (2).py" ]; then
            echo "script=parse_landtag_pdf (2).py" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Parser-Skript nicht gefunden (scripts/parse_landtag_pdf.py)."
            exit 1
          fi

      - name: Run parser (write to data)
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/scripts:${{ github.workspace }}/parser_core
        shell: bash
        run: |
          set -eo pipefail
          FORCE_FLAG=""
          if [ "${{ inputs.force_download }}" = "true" ]; then FORCE_FLAG="--force-download"; fi
          if [ -n "${{ inputs.pdf_url }}" ]; then
            echo "Parse single URL -> data/: ${{ inputs.pdf_url }}"
            python "${{ steps.detect.outputs.script }}" --single-url "${{ inputs.pdf_url }}" --out-dir data ${FORCE_FLAG}
          else
            if [ ! -f "${{ inputs.list_file }}" ]; then
              echo "::error::URLs-Liste nicht gefunden: ${{ inputs.list_file }}"
              exit 1
            fi
            echo "Parse list file -> data/: ${{ inputs.list_file }}"
            python "${{ steps.detect.outputs.script }}" --list-file "${{ inputs.list_file }}" --out-dir data ${FORCE_FLAG}
          fi
          echo "Inhalt von data/:"
          ls -lah data || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parsed-session-${{ github.run_id }}
          path: |
            data/session_*.json
            data/session_*.layout.json
          if-no-files-found: warn
          retention-days: 7

      - name: Commit data to repository
        shell: bash
        run: |
          set -eo pipefail
          if ls -1 data/session_*.json >/dev/null 2>&1; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A data
            git commit -m "chore(data): update parsed sessions" || echo "Nothing to commit"
            git push
          else
            echo "::warning::Keine Session-JSON in data/ gefunden. Nichts zu committen."
          fi
